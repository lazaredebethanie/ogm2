<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Maintenance Lines</title>
    <!-- <link href="../bootstrap/css/bootstrap.min.css" rel="stylesheet"> -->
    <link type="text/css" rel="stylesheet" media="all" title="CSS" href="../css/ogm.css" />
    <link type="text/css" rel="stylesheet" media="all" title="CSS" href="../css/onglets2.css" />
    <link href="../css/style.css" rel="stylesheet" />
    <link href="../_ressources/jsgrid/css/jsgrid.min.css" rel="stylesheet" />
    <link href="../_ressources/jsgrid/css/jsgrid-theme.min.css" rel="stylesheet" />
    <link href="../_ressources/jquery-ui/jquery-ui.css" rel="stylesheet" />
    
</head>
<body>
        <div class="onglets_html">
        <div class="onglets">
            <div class="onglet_n onglet"><a id="hrefContractDet" href="../screens/contractDetails.html">Contract Details</a></div>
            <div class="onglet_y onglet"><a id="hrefMaiLines" href="../screens/maintenance_lines.html">Maintenance Lines</a></div>
        </div>
        <div class="contenu">
    <table class="table table-striped table-responsive w-auto">
        <tbody>
            <tr>
                <td><h2>Contract : </h2></td>
                <td><h2 id="contract"></h2></td>
                <td>&nbsp;&nbsp;&nbsp;</td>
                <td><h2>Supplier : </h2></td>
                <td><h2 id="supplier"></h2></td>
            </tr>
        </tbody>
    </table>
    <!-- =================================================== NEW LINE ====================================================== -->
    <div id="newLine">
    <fieldset><h3>New line...</h3>
    <form name="addLineForm" id="addLineForm" method="post" enctype="multipart/form-data"  autocomplete="on">
      <table style="width: 100%;" border="0">
        <tbody>
          <tr>
            <td>Subject</td>
            <td colspan="3"><input id="description" name="description" size="100" type="text"> </td>
          </tr>
          <tr>
            <td>Start date</td>
            <td ><input id="addLineBegin" name="addLineBegin" type="date" size="14"></td>
            <td>Amount<br>
            </td>
            <td><input id="amount" name="amount" type="date" size="14"><br>
            </td>
          </tr>
          <tr>
            <td>End date or Duration</td>
            <td><input id="addLineEnd" name="addLineEnd" type="date" size="14"> </td>
            <td>
              <select name="time_unity" size="1">
                <option value="years">Years</option>
                <option value="months">Months</option>
                <option value="days">Days</option>
              </select>
            </td>
            <td><input name="nb_unity" size="5" type="number"> </td>
          </tr>
          <tr>
            <td>Budget years</td>
            <td colspan="3">
                <input name="budget_years" value="yes" checked="checked" type="radio"> Yes (imputation on each year)&nbsp;&nbsp; 
                <input name="budget_years" value="no" type="radio">No (imputation on the start year) 
            </td>
          </tr>
        </tbody>
      </table>
      <button id="addLine" type="button">Add</button> 
      <button name="reset" type="reset">Reset</button>
      <button id="closeNewLine" type="button">Close</button> <br>
    </form></fieldset>
    </div>
    <!-- =================================================== SELECTED LINE ====================================================== -->
    <div id="selLine"><fieldset>
      <h3> Selected lines... </h3>
      <button id="saveSelLine" type="button">Save</button> 
      <button id="saveCloseSelLine" type="button">Save &amp; Close</button> 
      <button id="closeSelLine" type="button">Close</button> <br><br>
      <table class="table table-striped table-responsive w-auto" >
                <tr>
                    <td>
                    Description
                    </td>
                    <td>
                    <input id="descriptionSelLine" type="text" size="100"></input>
                    </td>
                    <td>&nbsp;</td>
                    <td>
                    Total Amount 
                    </td>
                    <td>
                    <input id="total_amount" type="number" ></input>
                    </td>
                </tr>
      </table>
      <table class="table table-striped table-responsive w-auto" >
                  <tr>
                <td>
                    <table class="table table-striped table-responsive w-auto">
                        <tr>
                            <td>Global state</td>
                        </tr>
                        <tr>
                            <td>
                                <select id="selLineState" size="1">
                                    <option></option>
                                </select>
                            </td>
                        </tr>
                    </table>
                </td>
                <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>
                <td>
                    <table class="table table-striped table-responsive w-auto">
                    <thead>
                      <tr>
                        <td><br>
                        </td>
                        <td align="center">Quote asked</td>
                        <td align="center">Quote received</td>
                        <td align="center">Validation started</td>
                        <td align="center">Int. PO launched</td>
                        <td align="center">PO sent</td>
                        <td align="center">Payment authorized</td>
                        <td align="center">Invoice recorded</td>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td>Dates </td>
                        <td align="center"><input id="quote_asked" name="quote_asked" type="date" size="14"></td>
                        <td align="center"><input id="quote_received" name="quote_received" type="date" align="center" size="14"></td>
                        <td align="center"><input id="validation_started" name="validation_started" type="date" size="14"></td>
                        <td align="center"><input id="internal_po_date" name="internal_po_date" type="date" size="14"></td>
                        <td align="center"><input id="po_date" name="po_date" type="date" size="14"></td>
                        <td align="center"><input id="payment_authorized" name="payment_authorized" type="date" size="14"></td>
                        <td align="center"><input id="invoice_confirmed" name="invoice_confirmed" type="date" size="14"></td>
                      </tr>
                      <tr>
                        <td>References </td>
                        <td >&nbsp;</td>
                        <td><div id="quote_acceptable"><table>
                            <tr><td align="center">Acceptable ?</td></tr>
                            <tr>
                                <td align="center">
                                    <input name="quote_state" value="acceptable" type="radio"> Yes
                                    <input name="quote_state" value="reject" type="radio"> No
                                </td>
                            </tr>
                        </table></div></td>
                        <td><div id="workflow" align="center"><a id="wfl_link">Validation<br>workflow</a></div></td>
                        <td><input id="internal_po" name="internal_po" type="text" size="14"></td>
                        <td><input id="po" name="po" type="text" size="14"></td>
                        <td>&nbsp;</td>
                        <td><input id="invoice" name="invoice" type="text" size="14"></td>
                      </tr>
                    </tbody>
                  </table>  
               </td>
            </tr>
      

      </table>
      <br>
      <div>
      Comment <input id="comments" size="160"></input><br><br>
      <div id="grid_header"><h5>Budget distribution</h5><div id="error_distribution">
      <input type="hidden" id="amount_distribution"></input>
      </div></div>
      </div>
      <div id="jsGridSelectedLine">
      </div>
      <br>
    </fieldset></div>
    <div id="amountDialog" title="Action on amount...">
      <form id="amountForm"> 
        <input name="choice" id="choice" value="1" type="radio">&nbsp;Align the total amount of the line on amount of budget distribution</input><br>
        <input name="choice" id="choice" value="2" type="radio">&nbsp;Redistribute the budget (only if no evolution exists))</input> <br>
        <input name="choice" id="choice" value="3" type="radio" checked>&nbsp;Do nothing (by default)</input><br><br>
        <button id="closeDialogAmount" type="button">OK</button>
     </form> </div>
    
    <!-- =================================================== Lines of PERIODS ====================================================== -->
    
    <fieldset>
    <form name="lines_period" autocomplete="on">
      <h3>Existing periods...</h3>
      <button id="displayNewLine" type="button">Add</button>
      <button id="displayByYears" type="button">Display by years</button>
      <button id="displayByPeriods" type="button">Display by periods</button>
      <div id="jsGridExistingPeriod"></div>
      <p><br>
      </p>
    </form>
    </fieldset>
        </div>
    </div>
</body> 

 <!-- ************************* DEBUT PARTIE JS *****************************  -->
    <script src="../_ressources/jquery-3.3.1.min.js"></script>
    <script src="../_ressources/jquery-ui/jquery-ui.js"></script>
    <script src="../_ressources/jsgrid/jsgrid.min.js"></script>
    <script src="../common/common.js"></script>

    <script> 
           var argSec=location.search.substring(1, location.search.length).split('&');
           var contractId=argSec[0];
           $("#hrefContractDet").attr("href",$("#hrefContractDet").attr("href")+"?"+contractId);
           var argTmp;
           argTmp=argSec[1].split('=');
           $("#contract").html(decodeURIComponent(argTmp[1]));
           argTmp=argSec[2].split('=');
           $("#supplier").html(decodeURIComponent(argTmp[1]));
           $("#newLine").hide();
           //$("#selLine").hide(); // ********************************************     TEMPORAIRE
           //$("#workflow").hide();// ********************************************     TEMPORAIRE
           $("#displayByPeriods").hide();
           $("#displayNewLine").on("click",function() {
               $("#newLine").show();
           });
           $("#closeNewLine").on("click",function() {
               $("#newLine").hide();
           });       
           $("#closeSelLine").on("click",function() {
               $("#selLine").hide();
           }); 
           
           $("#addLineBegin").datepicker();
           $("#addLineBegin").datepicker( "option", "dateFormat", "yy-mm-dd" );
           $("#addLineEnd").datepicker();
           $("#addLineEnd").datepicker( "option", "dateFormat", "yy-mm-dd" );
           $("#quote_asked").datepicker();
           $("#quote_asked").datepicker( "option", "dateFormat", "yy-mm-dd" );
           $("#quote_received").datepicker();
           $("#quote_received").datepicker( "option", "dateFormat", "yy-mm-dd" );
           $("#validation_started").datepicker();
           $("#validation_started").datepicker( "option", "dateFormat", "yy-mm-dd" );
           $("#internal_po_date").datepicker();
           $("#internal_po_date").datepicker( "option", "dateFormat", "yy-mm-dd" );
           $("#po_date").datepicker();
           $("#po_date").datepicker( "option", "dateFormat", "yy-mm-dd" );
           $("#payment_authorized").datepicker();
           $("#payment_authorized").datepicker( "option", "dateFormat", "yy-mm-dd" );
           $("#invoice_confirmed").datepicker();
           $("#invoice_confirmed").datepicker( "option", "dateFormat", "yy-mm-dd" );
           
           dataSel=ajaxSelect("../calls/lifeCyclesIndex.php");
           appendState(dataSel);
           $("#grid_header").hide();
           $("#amountDialog").dialog({
               autoOpen: false,
               width: 500
           });
           
           $("#addLine").on("click",function(){
               addLineAjax();  
               //alert("AddLine");
           })     
           
           
           $("#closeDialogAmount").on("click",function(){
              $("#amountDialog").dialog("close"); 
              //alert($('input[name="choice"]:checked').val());
              switch ($('input[name="choice"]:checked').val()) {
              case "1":
                  $("#total_amount").val($("#amount_distribution").val());
                  break;
              case "2":
                  alert("to implement");
                  break;
              default:
                  alert("to implement");
                  break;
              }
           });

           // FUNCTIONS ==============================================================================
    
               // FUNCTIONS ADDLINE -+-+-+-+-+-+-+-+-+-+-+-+-+-+-
           
           function addLineAjax () {
               
               var formId="addLineForm";
               var formElmt = document.getElementById(formId);
               var formData = new FormData(formElmt);
               var contractIdNr=contractId.split("=");
               formData.append("contractId",contractIdNr[1]);
               //var fd=new FormData();
               //fd.append("aaa","bbb");
               $.ajax
                 ({
                   url: '../calls/MaintenanceLinesPeriodsIndex.php',                  //the script to call to get data          
                   data: formData,                       
                   processData: false,
                   contentType: false,
                   method: "POST",                                 
                   dataType: 'json',                //data format
                   error: function (xhr, ajaxOptions, thrownError) {
                       alert(xhr.status);
                       alert(thrownError);
                     }
                 }) 
                     .done (function () {
                         alert("addLineAjax success");    
                         $("#jsGridExistingPeriod").jsGrid("loadData");
                         deleteForm("#"+formId);
                         
                     })
                     .fail (function () {
                         alert('Error on "addLineAjax" : line not added');
                     })
                 
                 //.done(function(data) { // start DONE contractDetailsIndex
                }
               
               function deleteForm (formId) {
                   $(':input',formId)
                    .not(':button, :submit, :reset, :hidden')
                    .val('')
                    .removeAttr('checked')
                    .removeAttr('selected');
                 }
               // FUNCTION SELLINE -+-+-+-+-+-+-+-+-+-+-+-+-+-+-
               
           function displaySelLine(args) {
               
               $("#descriptionSelLine").val(args.item.description);
               $("#total_amount").val(args.item.total_amount);
               $("#selLineState").val(args.item.life_cycle_state_id);
               $("#quote_asked").datepicker("setDate",args.item.quote_asked);
               $("#quote_received").datepicker("setDate",args.item.quote_received);
               if (args.item.quote_received === null) {
                   $("#quote_acceptable").hide();
               } else {
                   // acceptable    $("#quote_state").attr("checked");
                   
               }
               $("#validation_started").datepicker("setDate",args.item.validation_started);
               if (args.item.validation_workflow_link === null) {
                   $("#workflow").hide();
               }  else {
                   $("#wfl_link").attr("href",args.item.validation_workflow_link)                   
               }
               $("#internal_po_date").datepicker("setDate",args.item.internal_po_date);
               $("#internal_po").val(args.item.internal_po_ref);
               $("#po_date").datepicker("setDate",args.item.po_date);
               $("#po").val(args.item.po_ref);
               $("#payment_authorized").datepicker("setDate",args.item.confirm_payment_date);
               $("#invoice_confirmed").datepicker("setDate",args.item.invoice_date);
               $("#invoice").val(args.item.invoice_ref);
               $("#comments").val(args.item.comments);
               //$("#quote_asked").datepicker("setDate",args.item.quote_asked);
               
               $("#selLine").show();
               $("#grid_header").show();
               selectedLineGrid(args.item.id,args.item.total_amount);
           }
           
           function appendState (dataSel,id) {
               for (let row of dataSel) {
                   //if (flOpt) {
                         $("#selLineState").append('<OPTION value="'+row["id"]+'">'+row["state"]);
                   //}
               }
           }; // end of appendState

           
    </script>
    
    <script src="../js/maintenanceLinesPeriods.js"></script>
    <script src="../js/budgetYears.js"></script>
</html>